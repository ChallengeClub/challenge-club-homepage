<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  {# --- タイトルの決定（三項演算子を使わない） --- #}
  {% if title and (title | length) > 0 %}
    {% set pageTitle = title ~ ' | ' ~ site.name %}
  {% else %}
    {% set pageTitle = site.defaultTitle %}
  {% endif %}

  {# --- ディスクリプション（front matter優先） --- #}
  {% if description and (description | length) > 0 %}
    {% set desc = description %}
  {% else %}
    {% set desc = site.defaultDescription %}
  {% endif %}

  {# --- OGP画像（image → ogImage → デフォルトの優先順） --- #}
  {% if image %}
    {% set ogImagePath = image %}
  {% elseif ogImage %}
    {% set ogImagePath = ogImage %}
  {% else %}
    {% set ogImagePath = site.defaultOg %}
  {% endif %}

  {# --- 絶対URLの作成（カスタムフィルタ無しで確実に） --- #}
  {% set pageUrl = site.url ~ (page.url | url) %}
  {% set ogImage = site.url ~ (ogImagePath | url) %}

  <title>{{ pageTitle }}</title>
  <link rel="canonical" href="{{ pageUrl }}">

  {# robots は必要な時だけ front matter で渡す #}
  {% if robots %}<meta name="robots" content="{{ robots }}">{% endif %}

  <meta name="description" content="{{ desc | replace('\n',' ') }}">

  {# --- OGP/Twitter --- #}
  {% if page.date and title %}
    {% set ogType = 'article' %}
  {% else %}
    {% set ogType = 'website' %}
  {% endif %}

  <meta property="og:type" content="{{ ogType }}">
  <meta property="og:locale" content="ja_JP">
  <meta property="og:site_name" content="{{ site.name }}">
  <meta property="og:title" content="{{ title or site.name }}">
  <meta property="og:description" content="{{ desc }}">
  <meta property="og:url" content="{{ pageUrl }}">
  <meta property="og:image" content="{{ ogImage }}">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:image:alt" content="{{ title or site.name }}">

  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="{{ title or site.name }}">
  <meta name="twitter:description" content="{{ desc }}">
  <meta name="twitter:image" content="{{ ogImage }}">

  <link rel="icon" type="image/png" href="{{ '/images/common/favicon.png' | url }}">
  <link rel="stylesheet" href="{{ '/styles/style.css' | url }}">

  {# --- 構造化データ（Organization / Website）--- #}
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"Organization",
    "name":"{{ site.name }}",
    "url":"{{ site.url }}",
    "logo":"{{ (site.logo | url) | replace('^//','/') | trim }}",
    "sameAs":[{% for s in site.sameAs %}"{{ s }}"{% if not loop.last %},{% endif %}{% endfor %}]
  }
  </script>

  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebSite",
    "url":"{{ site.url }}",
    "name":"{{ site.name }}",
    "potentialAction":{
      "@type":"SearchAction",
      "target":"{{ site.url }}/search?q={query}",
      "query-input":"required name=query"
    }
  }
  </script>

  {% if page.date and title %}
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"BlogPosting",
    "headline":"{{ title }}",
    "description":"{{ desc | replace('\n',' ') }}",
    "image":"{{ ogImage }}",
    "datePublished":"{{ page.date | date('yyyy-MM-dd') }}",
    "dateModified":"{{ page.date | date('yyyy-MM-dd') }}",
    "author":{"@type":"Organization","name":"{{ site.name }}"},
    "publisher":{
      "@type":"Organization",
      "name":"{{ site.name }}",
      "logo":{"@type":"ImageObject","url":"{{ site.url ~ (site.logo | url) }}"}
    },
    "mainEntityOfPage":"{{ pageUrl }}"
  }
  </script>
  {% endif %}
</head>
<body>

  {% include "header.njk" %}

  {% if image %}
  <section class="activity-header" style="background: url('{{ image | url }}') center/cover no-repeat;">
    <h1>{{ title }}</h1>
  </section>
  {% elseif title %}
  <h1 class="visually-hidden">{{ title }}</h1>
  {% endif %}

  <main>
    <section>
      {{ content | safe }}

      {% if tags and tags.length %}

      <section id="related-posts">
        <h2>関連ニュース＆トピックス</h2>
        <div class="news-list">
          {% set related = [] %}

          {# posts コレクションからタグ一致する記事を収集 #}
          {% for post in collections.posts %}
            {% if post.data.tags %}
              {% for t in tags %}
                {% if t in post.data.tags %}
                  {% set related = related + [post] %}
                {% endif %}
              {% endfor %}
            {% endif %}
          {% endfor %}

          {# URLで重複除去 → 新しい順に3件だけ #}
          {% set seen = [] %}
          {% set relatedUnique = [] %}
          {% for r in related | reverse %}
            {% if r.url not in seen %}
              {% set relatedUnique = relatedUnique + [r] %}
              {% set seen = seen + [r.url] %}
            {% endif %}
          {% endfor %}
          {% set related = relatedUnique | slice(0,3) %}

          {% if related.length > 0 %}
            {% for post in related %}
            <article class="news-item">
              <div class="news-thumbnail">
                <a href="{{ post.url | url }}">
                  {% set thumb = post.data.thumbnail %}
                  {% set autoThumb = post.templateContent | getFirstImageSrc %}
                  {% set imgSrc = thumb or autoThumb or '/images/common/default-thumbnail.png' %}
                  <img src="{{ imgSrc }}" alt="{{ post.data.title }}">
                </a>
              </div>
              <div class="news-content">
                <h3 class="news-title">
                  <a href="{{ post.url | url }}">{{ post.data.title }}</a>
                </h3>
                <div class="news-meta">
                  {% if post.date %}
                  <time datetime="{{ post.date | date('yyyy-MM-dd') }}">
                    {{ post.date | date('yyyy/MM/dd') }}
                  </time>
                  {% endif %}
                </div>
                {% if post.data.tags %}
                <div class="news-tags">
                  {% for t in post.data.tags %}
                    <a href="{{ ('/tags/' ~ (tagNames[t] or (t | safeSlug)) ~ '/') | url }}" class="tag-pill">{{ t }}</a>
                  {% endfor %}
                </div>
                {% endif %}
              </div>
            </article>
            {% endfor %}
          {% else %}
            <p>関連ニュースはまだありません。</p>
          {% endif %}
        </div>
      </section>

      <p class="tags">
        タグ:
        {% for tag in tags %}
          <a href="{{ ('/tags/' ~ (tagNames[tag] or (tag | safeSlug)) ~ '/') | url }}" class="tag-pill">{{ tag }}</a>
        {% endfor %}
      </p>

      {% endif %}
    </section>
  </main>

  {% include "footer.njk" %}
</body>
</html>
